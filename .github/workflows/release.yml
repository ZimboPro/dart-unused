name: Release

on:
    push:
        branches: [master]
        tags: ["v*"]
    workflow_dispatch:

env:
    CARGO_TERM_COLOR: always
    CARGO_REGISTRIES_CRATES_IO_PROTOCOL: sparse

jobs:
    build:
        name: Build Release Binary
        runs-on: ubuntu-latest
        timeout-minutes: 30

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Install Rust
              uses: dtolnay/rust-toolchain@stable
              with:
                  toolchain: "1.92.0"
                  targets: x86_64-unknown-linux-gnu

            - name: Cache cargo registry
              uses: actions/cache@v4
              with:
                  path: ~/.cargo/registry/cache
                  key: ${{ runner.os }}-release-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
                  restore-keys: ${{ runner.os }}-release-cargo-registry-

            - name: Cache cargo index
              uses: actions/cache@v4
              with:
                  path: ~/.cargo/registry/index
                  key: ${{ runner.os }}-release-cargo-index-${{ hashFiles('**/Cargo.lock') }}
                  restore-keys: ${{ runner.os }}-release-cargo-index-

            - name: Cache target directory
              uses: actions/cache@v4
              with:
                  path: target
                  key: ${{ runner.os }}-release-target-${{ hashFiles('**/Cargo.lock') }}
                  restore-keys: ${{ runner.os }}-release-target-

            - name: Build release binary
              run: cargo build --release --verbose

            - name: Strip binary
              run: strip target/release/dart-unused

            - name: Create archive
              run: |
                  mkdir -p release
                  cp target/release/dart-unused release/
                  cp LICENSE release/ 2>/dev/null || true
                  cp README.md release/ 2>/dev/null || true
                  tar -czf dart-unused-linux-x86_64.tar.gz -C release .

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: dart-unused-linux-x86_64
                  path: dart-unused-linux-x86_64.tar.gz
                  retention-days: 30

    release:
        name: Create GitHub Release
        runs-on: ubuntu-latest
        needs: build
        if: startsWith(github.ref, 'refs/tags/v')

        permissions:
            contents: write

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Download artifacts
              uses: actions/download-artifact@v4
              with:
                  name: dart-unused-linux-x86_64

            - name: Create Release
              uses: softprops/action-gh-release@v2
              with:
                  files: dart-unused-linux-x86_64.tar.gz
                  generate_release_notes: true
                  draft: false
                  prerelease: ${{ contains(github.ref, '-') }}
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
